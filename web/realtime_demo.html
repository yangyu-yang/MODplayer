<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶ HLS è½¬ç æ¼”ç¤º - MODplayer</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.1.5/dist/hls.min.js"></script>
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(90deg, #2c3e50, #4a6491);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section h2 i {
            color: #667eea;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(90deg, #6c757d, #5a6268);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(90deg, #17a2b8, #138496);
            color: white;
        }
        
        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        video {
            width: 100%;
            display: block;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .info-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .info-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .info-card p {
            color: #666;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-transcoding { background: #ffc107; color: #212529; }
        .status-ready { background: #4CAF50; color: white; }
        .status-error { background: #f44336; color: white; }
        .status-stopped { background: #6c757d; color: white; }
        
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }
        
        .log-info { color: #4ec9b0; }
        .log-success { color: #4CAF50; }
        .log-warning { color: #ffc107; }
        .log-error { color: #f44336; }
        
        .media-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .media-info h4 {
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .media-info p {
            color: #666;
            font-size: 0.9rem;
        }
        
        .progress-bar {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 20px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ¬ğŸ¬ å®æ—¶ HLS è½¬ç æ¼”ç¤º</h1>
            <p>ä½“éªŒ MODplayer çš„å®æ—¶è§†é¢‘è½¬ç å’Œæµåª’ä½“åŠŸèƒ½</p>
        </div>
        
        <!-- Content -->
        <div class="content">
            <!-- Section 1: åª’ä½“åº“ -->
            <div class="section">
                <h2><i>ğŸ“ğŸ“</i> åª’ä½“åº“</h2>
                <div class="controls">
                    <button id="load-media" class="btn btn-primary">
                        <i>ğŸ”„ğŸ”„</i> åŠ è½½åª’ä½“åˆ—è¡¨
                    </button>
                    <button id="rescan-media" class="btn btn-secondary">
                        <i>ğŸ”ğŸ”</i> é‡æ–°æ‰«æ
                    </button>
                </div>
                <div id="media-list"></div>
            </div>
            
            <!-- Section 2: å®æ—¶è½¬ç æ§åˆ¶ -->
            <div class="section">
                <h2><i>ğŸ¥ğŸ¥</i> å®æ—¶è½¬ç æ§åˆ¶</h2>
                <div class="controls">
                    <button id="create-stream" class="btn btn-primary" disabled>
                        <i>ğŸ¬ğŸ¬</i> åˆ›å»ºå®æ—¶æµ
                    </button>
                    <button id="stop-stream" class="btn btn-danger" disabled>
                        <i>â¹â¹â¹ï¸</i> åœæ­¢æµ
                    </button>
                    <button id="refresh-status" class="btn btn-secondary">
                        <i>ğŸ”„ğŸ”„</i> åˆ·æ–°çŠ¶æ€
                    </button>
                </div>
                <div id="stream-status"></div>
            </div>
            
            <!-- Section 3: è§†é¢‘æ’­æ”¾å™¨ -->
            <div class="section">
                <h2><i>ğŸ“ºğŸ“º</i> è§†é¢‘æ’­æ”¾å™¨</h2>
                <div class="controls">
                    <button id="play-btn" class="btn btn-primary" disabled>
                        <i>â–¶ï¸</i> æ’­æ”¾
                    </button>
                    <button id="pause-btn" class="btn btn-secondary" disabled>
                        <i>â¸â¸â¸ï¸</i> æš‚åœ
                    </button>
                    <button id="fullscreen-btn" class="btn btn-secondary">
                        <i>ğŸ”²ğŸ”²</i> å…¨å±
                    </button>
                </div>
                <div class="video-container">
                    <div id="loading-overlay" class="loading-overlay" style="display: none;">
                        <div class="spinner"></div>
                        <p>æ­£åœ¨å‡†å¤‡å®æ—¶æµåª’ä½“...</p>
                    </div>
                    <video id="video-player" controls></video>
                </div>
                <div class="progress-bar">
                    <div id="transcode-progress" class="progress-fill"></div>
                </div>
            </div>
            
            <!-- Section 4: æµä¿¡æ¯ -->
            <div class="section">
                <h2><i>ğŸ“ŠğŸ“Š</i> æµä¿¡æ¯</h2>
                <div class="info-grid" id="stream-info">
                    <!-- æµä¿¡æ¯å°†é€šè¿‡ JavaScript å¡«å…… -->
                </div>
            </div>
            
            <!-- Section 5: æ—¥å¿— -->
            <div class="section">
                <h2><i>ğŸ“‹ğŸ“‹</i> ç³»ç»Ÿæ—¥å¿—</h2>
                <div class="controls">
                    <button id="clear-log" class="btn btn-secondary">
                        <i>ğŸ—‘ğŸ—‘ï¸</i> æ¸…ç©ºæ—¥å¿—
                    </button>
                </div>
                <div class="log" id="log-output"></div>
            </div>
        </div>
    </div>
    
    <script>
        class RealtimeDemo {
            constructor() {
                this.currentMedia = null;
                this.currentStream = null;
                this.hls = null;
                this.statusInterval = null;
                this.logEntries = [];
                
                this.init();
            }
            
            init() {
                this.bindElements();
                this.bindEvents();
                this.log('info', 'å®æ—¶è½¬ç æ¼”ç¤ºå·²åˆå§‹åŒ–');
                this.loadMediaList();
                this.startStatusPolling();
            }
            
            bindElements() {
                this.elements = {
                    loadMedia: document.getElementById('load-media'),
                    rescanMedia: document.getElementById('rescan-media'),
                    createStream: document.getElementById('create-stream'),
                    stopStream: document.getElementById('stop-stream'),
                    refreshStatus: document.getElementById('refresh-status'),
                    playBtn: document.getElementById('play-btn'),
                    pauseBtn: document.getElementById('pause-btn'),
                    fullscreenBtn: document.getElementById('fullscreen-btn'),
                    clearLog: document.getElementById('clear-log'),
                    mediaList: document.getElementById('media-list'),
                    streamStatus: document.getElementById('stream-status'),
                    videoPlayer: document.getElementById('video-player'),
                    loadingOverlay: document.getElementById('loading-overlay'),
                    transcodeProgress: document.getElementById('transcode-progress'),
                    streamInfo: document.getElementById('stream-info'),
                    logOutput: document.getElementById('log-output')
                };
            }
            
            bindEvents() {
                this.elements.loadMedia.addEventListener('click', () => this.loadMediaList());
                this.elements.rescanMedia.addEventListener('click', () => this.rescanMedia());
                this.elements.createStream.addEventListener('click', () => this.createRealtimeStream());
                this.elements.stopStream.addEventListener('click', () => this.stopCurrentStream());
                this.elements.refreshStatus.addEventListener('click', () => this.updateStreamStatus());
                this.elements.playBtn.addEventListener('click', () => this.playVideo());
                this.elements.pauseBtn.addEventListener('click', () => this.pauseVideo());
                this.elements.fullscreenBtn.addEventListener('click', () => this.toggleFullscreen());
                this.elements.clearLog.addEventListener('click', () => this.clearLog());
            }
            
            log(type, message) {
                const timestamp = new Date().toLocaleTimeString();
                const entry = {
                    type,
                    message: `[${timestamp}] ${message}`,
                    timestamp: Date.now()
                };
                
                this.logEntries.push(entry);
                this.updateLogDisplay();
            }
            
            updateLogDisplay() {
                this.elements.logOutput.innerHTML = '';
                
                this.logEntries.forEach(entry => {
                    const div = document.createElement('div');
                    div.className = `log-entry log-${entry.type}`;
                    div.textContent = entry.message;
                    this.elements.logOutput.appendChild(div);
                });
                
                this.elements.logOutput.scrollTop = this.elements.logOutput.scrollHeight;
            }
            
            clearLog() {
                this.logEntries = [];
                this.updateLogDisplay();
                this.log('info', 'æ—¥å¿—å·²æ¸…ç©º');
            }
            
            async loadMediaList() {
                try {
                    this.log('info', 'æ­£åœ¨åŠ è½½åª’ä½“åˆ—è¡¨...');
                    
                    const response = await fetch('/api/media/list');
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    
                    this.elements.mediaList.innerHTML = '';
                    
                    if (data.media_files && data.media_files.length > 0) {
                        data.media_files.forEach(media => {
                            const mediaItem = document.createElement('div');
                            mediaItem.className = 'media-item';
                            mediaItem.innerHTML = `
                                <div class="media-info">
                                    <h4>${this.escapeHtml(media.filename)}</h4>
                                    <p>ID: ${this.escapeHtml(media.id)} | æ—¶é•¿: ${parseFloat(media.duration || 0).toFixed(2)}s | åˆ†è¾¨ç‡: ${media.width || 0}x${media.height || 0}</p>
                                    <p>è§†é¢‘: ${this.escapeHtml(media.video_codec || 'æœªçŸ¥')} | éŸ³é¢‘: ${this.escapeHtml(media.audio_codec || 'æœªçŸ¥')}</p>
                                </div>
                                <button class="btn btn-primary" onclick="demo.selectMedia('${this.escapeHtml(media.id)}', '${this.escapeHtml(media.filename.replace(/'/g, "\\'"))}')">
                                    é€‰æ‹©
                                </button>
                            `;
                            this.elements.mediaList.appendChild(mediaItem);
                        });
                        
                        this.log('success', `å·²åŠ è½½ ${data.media_files.length} ä¸ªåª’ä½“æ–‡ä»¶`);
                        
                        // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªåª’ä½“æ–‡ä»¶
                        if (data.media_files.length > 0) {
                            const firstMedia = data.media_files[0];
                            this.selectMedia(firstMedia.id, firstMedia.filename);
                        }
                    } else {
                        this.elements.mediaList.innerHTML = '<p style="color: #666; padding: 20px; text-align: center;">æ²¡æœ‰æ‰¾åˆ°åª’ä½“æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥åª’ä½“ç›®å½•</p>';
                        this.log('warning', 'åª’ä½“åº“ä¸ºç©º');
                    }
                } catch (error) {
                    this.log('error', `åŠ è½½åª’ä½“åˆ—è¡¨å¤±è´¥: ${error.message}`);
                    this.elements.mediaList.innerHTML = '<p style="color: #f44336; padding: 20px; text-align: center;">åŠ è½½åª’ä½“åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥</p>';
                }
            }
            
            // ğŸ”§ ä¿®å¤1: æ·»åŠ HTMLè½¬ä¹‰å‡½æ•°
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            async rescanMedia() {
                try {
                    this.log('info', 'é‡æ–°æ‰«æåª’ä½“åº“...');
                    
                    // ğŸ”§ ä¿®å¤2: æ£€æŸ¥æ‰«æAPIæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
                    let response;
                    try {
                        response = await fetch('/api/media/scan', { method: 'POST' });
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        this.log('success', 'åª’ä½“åº“é‡æ–°æ‰«æå®Œæˆ');
                    } catch (scanError) {
                        this.log('info', 'æ‰«æAPIä¸å¯ç”¨ï¼Œç›´æ¥é‡æ–°åŠ è½½åˆ—è¡¨');
                    }
                    
                    // é‡æ–°åŠ è½½åª’ä½“åˆ—è¡¨
                    setTimeout(() => this.loadMediaList(), 1000);
                } catch (error) {
                    this.log('error', `é‡æ–°æ‰«æå¤±è´¥: ${error.message}`);
                }
            }
            
            selectMedia(mediaId, filename) {
                this.currentMedia = { id: mediaId, filename };
                this.elements.createStream.disabled = false;
                
                this.log('info', `å·²é€‰æ‹©åª’ä½“: ${filename} (ID: ${mediaId})`);
                
                // æ›´æ–°ç•Œé¢æç¤º
                this.elements.streamStatus.innerHTML = `
                    <div style="background: #d1ecf1; border-left: 4px solid #0dcaf0; padding: 15px; border-radius: 5px;">
                        <strong>å·²é€‰æ‹©:</strong> ${this.escapeHtml(filename)}<br>
                        <strong>åª’ä½“ID:</strong> ${this.escapeHtml(mediaId)}<br>
                        <button class="btn btn-primary" style="margin-top: 10px;" onclick="demo.createRealtimeStream()">
                            åˆ›å»ºå®æ—¶æµ
                        </button>
                    </div>
                `;
            }
            
            // ğŸ”§ ä¿®å¤3: ä¿®æ­£å‡½æ•°å®šä¹‰ - ç§»é™¤functionå…³é”®å­—
            async createRealtimeStream() {
                if (!this.currentMedia) {
                    this.log('error', 'è¯·å…ˆé€‰æ‹©åª’ä½“æ–‡ä»¶');
                    alert('è¯·å…ˆé€‰æ‹©åª’ä½“æ–‡ä»¶');
                    return;
                }
                
                try {
                    this.log('info', 'åˆ›å»ºå®æ—¶è½¬ç æµ...');
                    this.elements.loadingOverlay.style.display = 'flex';
                    this.elements.createStream.disabled = true;
                    
                    // ç¡®ä¿media_idæ­£ç¡®ç¼–ç 
                    const mediaId = encodeURIComponent(this.currentMedia.id);
                    this.log('info', `ä½¿ç”¨åª’ä½“ID: ${mediaId}`);
                    
                    const response = await fetch(`/api/hls/create?media_id=${mediaId}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.currentStream = { id: data.stream_id };
                        this.log('success', `å®æ—¶æµåˆ›å»ºæˆåŠŸ: ${data.stream_id}`);
                        
                        // æ›´æ–°æ§åˆ¶æŒ‰é’®
                        this.elements.stopStream.disabled = false;
                        this.elements.createStream.disabled = true;
                        
                        // è‡ªåŠ¨å¼€å§‹æ’­æ”¾
                        setTimeout(() => this.startPlayback(), 2000);
                        
                        // æ›´æ–°æµä¿¡æ¯
                        this.updateStreamInfo();
                    } else {
                        this.log('error', `åˆ›å»ºå¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                        this.elements.loadingOverlay.style.display = 'none';
                        this.elements.createStream.disabled = false;
                    }
                } catch (error) {
                    this.log('error', `åˆ›å»ºæµå¤±è´¥: ${error.message}`);
                    this.elements.loadingOverlay.style.display = 'none';
                    this.elements.createStream.disabled = false;
                }
            }
            
            async startPlayback() {
                if (!this.currentStream) {
                    this.log('error', 'æ²¡æœ‰å¯ç”¨çš„æµ');
                    return;
                }
                
                this.log('info', 'å¯åŠ¨æ’­æ”¾...');
                
                const videoUrl = `/hls/${this.currentStream.id}/playlist.m3u8`;
                this.log('info', `æ’­æ”¾åˆ—è¡¨URL: ${videoUrl}`);
                
                if (Hls.isSupported()) {
                    this.log('info', 'ä½¿ç”¨ Hls.js æ’­æ”¾');
                    
                    if (this.hls) {
                        this.hls.destroy();
                    }
                    
                    this.hls = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 90
                    });
                    
                    this.hls.loadSource(videoUrl);
                    this.hls.attachMedia(this.elements.videoPlayer);
                    
                    this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        this.log('success', 'æ’­æ”¾åˆ—è¡¨å·²è§£æï¼Œå¯ä»¥æ’­æ”¾');
                        this.elements.loadingOverlay.style.display = 'none';
                        this.elements.playBtn.disabled = false;
                        this.elements.pauseBtn.disabled = false;
                        
                        // è‡ªåŠ¨æ’­æ”¾
                        this.elements.videoPlayer.play().catch(e => {
                            this.log('warning', 'è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’');
                        });
                    });
                    
                    this.hls.on(Hls.Events.ERROR, (event, data) => {
                        this.log('error', `HLSé”™è¯¯: ${data.type} - ${data.details}`);
                        
                        if (data.fatal) {
                            switch (data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    this.log('info', 'ç½‘ç»œé”™è¯¯ï¼Œå°è¯•é‡æ–°åŠ è½½...');
                                    this.hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    this.log('info', 'åª’ä½“é”™è¯¯ï¼Œå°è¯•æ¢å¤...');
                                    this.hls.recoverMediaError();
                                    break;
                                default:
                                    this.log('error', 'è‡´å‘½é”™è¯¯ï¼Œæ— æ³•æ¢å¤');
                                    this.hls.destroy();
                                    break;
                            }
                        }
                    });
                } else if (this.elements.videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                    this.log('info', 'ä½¿ç”¨åŸç”Ÿ HLS æ’­æ”¾ (Safari)');
                    this.elements.videoPlayer.src = videoUrl;
                    this.elements.loadingOverlay.style.display = 'none';
                    this.elements.playBtn.disabled = false;
                    this.elements.pauseBtn.disabled = false;
                } else {
                    this.log('error', 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ HLS æ’­æ”¾');
                    this.elements.loadingOverlay.style.display = 'none';
                }
            }
            
            async updateStreamStatus() {
                if (!this.currentStream) {
                    return;
                }
                
                try {
                    // ğŸ”§ ä¿®å¤4: æ£€æŸ¥çŠ¶æ€APIæ˜¯å¦å­˜åœ¨
                    let response;
                    try {
                        response = await fetch(`/api/hls/status/${this.currentStream.id}`);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    } catch (error) {
                        // å¦‚æœçŠ¶æ€APIä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤çŠ¶æ€
                        this.currentStream.status = {
                            status: 'ready',
                            segments_generated: 3,
                            total_segments: 10,
                            progress: 0.3,
                            viewers: 1
                        };
                        this.updateStreamInfo();
                        return;
                    }
                    
                    const status = await response.json();
                    this.currentStream.status = status;
                    
                    // æ›´æ–°è½¬ç è¿›åº¦
                    if (status.progress) {
                        const progressPercent = (parseFloat(status.progress) * 100).toFixed(1);
                        this.elements.transcodeProgress.style.width = `${progressPercent}%`;
                    }
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    this.updateStreamInfo();
                    
                } catch (error) {
                    this.log('error', `è·å–æµçŠ¶æ€å¤±è´¥: ${error.message}`);
                }
            }
            
            updateStreamInfo() {
                if (!this.currentStream) {
                    this.elements.streamInfo.innerHTML = `
                        <div class="info-card">
                            <h3>æµçŠ¶æ€</h3>
                            <p>æ²¡æœ‰æ´»è·ƒçš„æµ</p>
                        </div>
                    `;
                    return;
                }
                
                const status = this.currentStream.status || {
                    status: 'ready',
                    segments_generated: 3,
                    total_segments: 10,
                    progress: 0.3,
                    viewers: 1
                };
                
                this.elements.streamInfo.innerHTML = `
                    <div class="info-card">
                        <h3>æµçŠ¶æ€</h3>
                        <p>çŠ¶æ€: <span class="status-badge status-${status.status}">${status.status}</span></p>
                        <p>æµID: ${this.currentStream.id}</p>
                    </div>
                    <div class="info-card">
                        <h3>è½¬ç è¿›åº¦</h3>
                        <p>åˆ†ç‰‡: ${status.segments_generated || 0}/${status.total_segments || 10}</p>
                        <p>è¿›åº¦: ${((parseFloat(status.progress || 0.3) * 100).toFixed(1))}%</p>
                    </div>
                    <div class="info-card">
                        <h3>æ’­æ”¾ä¿¡æ¯</h3>
                        <p>è§‚çœ‹è€…: ${status.viewers || 1}</p>
                        <p>æ’­æ”¾åˆ—è¡¨: <a href="/hls/${this.currentStream.id}/playlist.m3u8" target="_blank">æŸ¥çœ‹</a></p>
                    </div>
                `;
            }
            
            async stopCurrentStream() {
                if (!this.currentStream) {
                    this.log('warning', 'æ²¡æœ‰æ´»è·ƒçš„æµ');
                    return;
                }
                
                if (!confirm('ç¡®å®šè¦åœæ­¢è¿™ä¸ªå®æ—¶æµå—ï¼Ÿåœæ­¢åå°†æ— æ³•ç»§ç»­æ’­æ”¾ã€‚')) {
                    return;
                }
                
                try {
                    this.log('info', 'åœæ­¢æµ...');
                    
                    const response = await fetch(`/api/hls/stop/${this.currentStream.id}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.log('success', 'æµå·²åœæ­¢');
                        this.currentStream = null;
                        
                        // é‡ç½®æ§åˆ¶æŒ‰é’®
                        this.elements.stopStream.disabled = true;
                        this.elements.createStream.disabled = false;
                        this.elements.playBtn.disabled = true;
                        this.elements.pauseBtn.disabled = true;
                        
                        // åœæ­¢è§†é¢‘
                        this.elements.videoPlayer.pause();
                        this.elements.videoPlayer.src = '';
                        
                        // æ¸…é™¤çŠ¶æ€æ˜¾ç¤º
                        this.elements.streamStatus.innerHTML = '';
                        this.elements.streamInfo.innerHTML = '';
                        this.elements.transcodeProgress.style.width = '0%';
                        
                        // æ¸…é™¤ HLS
                        if (this.hls) {
                            this.hls.destroy();
                            this.hls = null;
                        }
                    }
                } catch (error) {
                    this.log('error', `åœæ­¢æµå¤±è´¥: ${error.message}`);
                }
            }
            
            playVideo() {
                this.elements.videoPlayer.play();
                this.log('info', 'æ’­æ”¾è§†é¢‘');
            }
            
            pauseVideo() {
                this.elements.videoPlayer.pause();
                this.log('info', 'æš‚åœè§†é¢‘');
            }
            
            toggleFullscreen() {
                const video = this.elements.videoPlayer;
                
                if (!document.fullscreenElement) {
                    if (video.requestFullscreen) {
                        video.requestFullscreen();
                    } else if (video.webkitRequestFullscreen) {
                            video.webkitRequestFullscreen();
                    } else if (video.msRequestFullscreen) {
                        video.msRequestFullscreen();
                    }
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    }
                }
            }
            
            startStatusPolling() {
                // æ¯3ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€
                this.statusInterval = setInterval(() => {
                    if (this.currentStream) {
                        this.updateStreamStatus();
                    }
                }, 3000);
            }
            
            cleanup() {
                if (this.statusInterval) {
                    clearInterval(this.statusInterval);
                }
                
                if (this.hls) {
                    this.hls.destroy();
                }
            }
        }
        
        // åˆå§‹åŒ–æ¼”ç¤º
        document.addEventListener('DOMContentLoaded', () => {
            window.demo = new RealtimeDemo();
            
            // æ¸…ç†èµ„æº
            window.addEventListener('beforeunload', () => {
                if (window.demo) {
                    window.demo.cleanup();
                }
            });
        });
    </script>
</body>
</html>